## 接口设计：系统间对话的语言，一定要统一

> 开发一个服务的第一步就是设计接口。接口的设计需要考虑的点非常多，比如接口的命名、参数列表、**包装结构体**、接口粒度、**版本策略
**、幂等性实现、**同步异步处理方式**等

### 1. 接口的响应要明确表示接口的处理结果：

参考代码：[apiresponse](apiresponse)

> 针对响应体的设计混乱、响应结果的不明确问题，服务端需要明确响应体每一个字段的意义，以一致的方式进行处理，并确保不透传下游服务的错误

#### 错误示范

```json
{
  "success": true,
  "code": 5001,
  "info": "Risk order detected",
  "message": "OK",
  "data": {
    "orderStatus": "Cancelled",
    "orderId": -1
  }
}
```

- success 是 true、message 是 OK，貌似代表下单成功了；
- 但 info 里却提示订单存在风险，code 是一个 5001 的错误码，data 中能看到订单状态是 Cancelled，订单 ID 是 -1，好像又说明没有下单成功

```json
{
  "success": false,
  "code": 0,
  "info": "",
  "message": "Illegal userId",
  "data": {
    "orderStatus": "Created",
    "orderId": 0
  }
}
```

- success 是 false，message 提示非法用户 ID，看上去下单失败；
- 但 data 里的 orderStatus 是 Created、info 是空、code 是 0。那么，这次下单到底是成功还是失败呢？

#### 灵魂拷问

- 结构体的 code 和 HTTP 响应状态码，是什么关系？
    - Code 不建议和 HTTP Status Code 有对应关系，这样容易产生误解
    - 一般用 0 表示成功状态，非 0 表示失败，然后根据具体业务进行细分
    - 客户端处理响应时应该先校验 HTTP 状态码是否为 200，然后再根据具体 Code 处理业务结果
- success 到底代表下单成功还是失败？
- info 和 message 的区别是什么？
    - 结构体中的 message 和 success，其实是服务的处理异常信息和处理成功与否的结果，code、info 是调用服务的结果
- data 中永远都有数据吗？
- 什么时候应该去查询 data？

#### 接口设计原则

- 对外隐藏内部实现。虽然说收单服务调用订单服务进行真正的下单操作，但是直接接口其实是收单服务提供的，收单服务不应该“直接”暴露其背后订单服务的状态码、错误描述
- 设计接口结构时，明确每个字段的含义，以及客户端的处理方式

#### 接口的设计逻辑

- **如果出现非 200 的 HTTP 响应状态码**
  ，就代表请求没有到收单服务，可能是网络出问题、网络超时，或者网络配置的问题。这时，肯定无法拿到服务端的响应体，客户端可以给予友好提示，比如让用户重试，不需要继续解析响应结构体。
- **如果 HTTP 响应码是 200**，解析响应体查看 success，为 false
  代表下单请求处理失败，可能是因为收单服务参数验证错误，也可能是因为订单服务下单操作失败。这时，根据收单服务定义的错误码表和
  code，做不同处理。比如友好提示，或是让用户重新填写相关信息，其中友好提示的文字内容可以从 message 中获取。
- **success 为 true 的情况下，才需要继续解析响应体中的 data 结构体**。data 结构体代表了业务数据，通常会有下面两种情况。
    - 通常情况下，success 为 true 时订单状态是 Created，获取 orderId 属性可以拿到订单号。
    - 特殊情况下，比如收单服务内部处理不当，或是订单服务出现了额外的状态，虽然 success 为 true，但订单实际状态不是
      Created，这时可以给予友好的错误提示。

![undefined](http://ww1.sinaimg.cn/large/002eBIeDgy1gucrww6sa1j62mg1zldn302.jpg)

### 2. 要考虑接口变迁的版本控制策略

参考代码：[apiversion](apiversion)

> 针对接口版本控制问题，主要就是在开发接口之前明确版本控制策略，以及尽量使用统一的版本控制策略两方面

- 版本策略最好一开始就考虑
- 版本实现方式要统一

### 3. 接口处理方式要明确同步还是异步

参考代码：[apiasyncsyncmode](apiasyncsyncmode)

> 针对接口的处理方式，我认为需要明确要么是同步要么是异步。如果 API 列表中既有同步接口也有异步接口，那么最好直接在接口名中明确

- 所谓同步处理，接口一定是同步上传原文件和缩略图的，调用方可以自己选择调用超时，如果来得及可以一直等到上传完成，如果等不及可以结束等待，下一次再重试；
- 所谓异步处理，接口是两段式的，上传接口本身只是返回一个任务 ID，然后异步做上传操作，上传接口响应很快，客户端需要之后再拿着任务
  ID 调用任务查询接口查询上传的文件 URL。

### 4. 请求头路由API版本的例子

参考代码：[headerapiversion](headerapiversion)